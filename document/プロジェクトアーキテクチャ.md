# LSP System プロジェクトアーキテクチャ

## 概要

LSP System は、Flutter を使用したクロスプラットフォーム対応の労働力管理システムです。
Web、モバイル（iOS/Android）、デスクトップ（Windows/macOS/Linux）に対応しています。

## 技術スタック

### コアフレームワーク

- **Flutter**: 3.7.2+
- **Dart**: 3.7.2+

### 主要パッケージ

- **go_router**: 14.6.2 - 宣言的ルーティング
- **flutter_riverpod**: 2.6.1 - 状態管理
- **riverpod_annotation**: 2.6.1 - コード生成による状態管理
- **shared_preferences**: 2.3.3 - ローカルストレージ

### 開発ツール

- **build_runner**: 2.4.13 - コード生成ツール
- **riverpod_generator**: 2.6.2 - Riverpod コード生成
- **riverpod_lint**: 2.6.2 - Riverpod 用 Lint ルール

## ディレクトリ構造

```
lib/
├── main.dart                 # アプリケーションエントリーポイント
├── app.dart                  # ルートウィジェット
├── router/                   # ルーティング設定
│   ├── app_router.dart
│   └── app_router.g.dart    # 自動生成
├── features/                 # 機能別モジュール
│   ├── auth/                 # 認証モジュール
│   │   ├── presentation/    # UIレイヤー
│   │   │   └── login_page.dart
│   │   ├── providers/       # 状態管理
│   │   │   ├── auth_provider.dart
│   │   │   └── auth_provider.g.dart
│   │   └── models/          # データモデル
│   │       └── user_model.dart
│   ├── home/                 # ホーム画面モジュール
│   │   └── presentation/
│   │       └── home_page.dart
│   ├── workforce_planning/  # 労働力計画モジュール
│   │   └── presentation/
│   │       ├── workforce_forecast_page.dart
│   │       ├── operation_plan_page.dart
│   │       └── work_assignment_page.dart
│   ├── work_model/          # 作業モデル管理モジュール
│   │   └── presentation/
│   │       └── work_model_page.dart
│   ├── progress/            # 作業実績進捗管理モジュール
│   │   └── presentation/
│   │       ├── progress_page.dart
│   │       ├── progress_personal_page.dart
│   │       ├── progress_manager_page.dart
│   │       └── progress_completion_rate_page.dart
│   ├── analytics/           # 分析レポートモジュール
│   │   └── presentation/
│   │       ├── analytics_page.dart
│   │       ├── analytics_budget_page.dart
│   │       ├── analytics_variance_page.dart
│   │       └── analytics_productivity_page.dart
│   └── personal/            # デジタル個人サービスモジュール
│       └── presentation/
│           ├── personal_services_page.dart
│           ├── personal_plan_revision_page.dart
│           ├── personal_leave_request_page.dart
│           ├── personal_schedule_change_page.dart
│           └── personal_application_page.dart
├── shared/                   # 共有コンポーネント
│   ├── widgets/             # 再利用可能なウィジェット
│   │   ├── loading_indicator.dart
│   │   └── feature_page_scaffold.dart
│   ├── constants/           # 定数定義
│   │   └── route_paths.dart
│   └── theme/               # テーマ設定
│       └── app_theme.dart
└── core/                     # コア機能
    ├── storage/             # ローカルストレージ
    │   ├── storage_service.dart
    │   └── storage_service.g.dart
    └── utils/               # ユーティリティ
        └── constants.dart
```

## アーキテクチャパターン

### Feature-First 構造

各機能モジュールは独立したディレクトリとして構成され、以下のレイヤーを含みます：

1. **Presentation Layer** (`presentation/`)

   - UI ウィジェット
   - 画面の構成とレイアウト

2. **State Management** (`providers/`)

   - Riverpod プロバイダー
   - ビジネスロジック
   - 状態管理

3. **Data Models** (`models/`)
   - データクラス
   - エンティティ定義

### 依存関係の方向

```
Presentation → Providers → Core Services
     ↓           ↓              ↓
  Widgets    State Mgmt    Storage/Utils
```

## 主要コンポーネント

### 認証システム

#### AuthStateProvider

- ログイン状態の管理
- ローカルストレージとの連携
- 認証フローの制御

```dart
@riverpod
class AuthState extends _$AuthState {
  // ログイン状態の管理
  // ログイン/ログアウト機能
}
```

### ストレージサービス

#### StorageService

- SharedPreferences のラッパー
- キー管理の一元化
- タイプセーフなデータアクセス

### ルーティング

#### AppRouter

- go_router ベースの宣言的ルーティング
- 認証ガードの実装
- 全ページへのナビゲーション定義

### テーマシステム

#### AppTheme

- Material Design 3 対応
- ライトモード/ダークモード対応
- カスタマイズ可能なテーマ設定

## 状態管理戦略

### Riverpod の使用

1. **コード生成の活用**

   - `@riverpod` アノテーションを使用
   - タイプセーフなプロバイダー
   - 自動的な依存関係管理

2. **プロバイダーの種類**

   - `StateProvider`: シンプルな状態管理
   - `StateNotifierProvider`: 複雑な状態とロジック
   - `FutureProvider`: 非同期データ

3. **ベストプラクティス**
   - 各機能モジュールに専用のプロバイダー
   - グローバル状態は最小限に
   - テスタビリティを重視

## データフロー

```
ユーザー操作
    ↓
Presentationレイヤー (Widget)
    ↓
Providerレイヤー (ビジネスロジック)
    ↓
Coreサービス (Storage/API)
    ↓
外部リソース (ローカルストレージ/API)
```

## コーディング規約

### ファイル命名規則

- ファイル名: `snake_case`
- クラス名: `PascalCase`
- 変数/関数名: `camelCase`
- 定数: `lowerCamelCase` (Dart の慣例)

### コメント規則

- 日本語コメントを使用
- コメントはコードの上の行に配置
- 行末コメントは禁止
- 関数にはドキュメントコメント (`///`) を使用

### インポート順序

1. Dart コアライブラリ
2. Flutter ライブラリ
3. サードパーティパッケージ
4. プロジェクト内のファイル

## ビルドとデプロイ

### コード生成

```bash
flutter pub run build_runner build --delete-conflicting-outputs
```

### 開発サーバー起動

```bash
flutter run -d chrome  # Web
flutter run -d windows # Windows
flutter run            # モバイル
```

### ビルド

```bash
flutter build web      # Web
flutter build windows  # Windows
flutter build apk      # Android
flutter build ios      # iOS
```

## テスト戦略

### 単体テスト

- プロバイダーのロジックテスト
- モデルクラスのテスト
- ユーティリティ関数のテスト

### ウィジェットテスト

- 各ページコンポーネントのテスト
- 共有ウィジェットのテスト

### 統合テスト

- エンドツーエンドのユーザーフロー
- 認証フローのテスト

## 今後の拡張

### バックエンド統合

- REST API 連携の追加
- データ同期機能
- オフライン対応

### 追加機能

- 多言語対応 (i18n)
- プッシュ通知
- データエクスポート機能
- 高度な分析機能

### パフォーマンス最適化

- 画像の遅延読み込み
- キャッシュ戦略の実装
- バンドルサイズの最適化

## セキュリティ考慮事項

### 現在の実装

- ローカル認証状態の管理
- SharedPreferences による状態永続化

### 今後の実装予定

- トークンベース認証 (JWT)
- セキュアストレージの使用
- API 通信の暗号化
- 権限ベースのアクセス制御

## パフォーマンス

### 最適化ポイント

- Riverpod による効率的な状態管理
- 必要な箇所のみの再ビルド
- 適切なウィジェットの const 使用
- 遅延ローディングの活用

## メンテナンス

### 依存関係の更新

```bash
flutter pub outdated
flutter pub upgrade
```

### コード品質チェック

```bash
flutter analyze
dart format lib/
```

## サポートプラットフォーム

- ✅ Web (Chrome, Firefox, Safari, Edge)
- ✅ Android (API 21+)
- ✅ iOS (iOS 12+)
- ✅ Windows (Windows 10+)
- ✅ macOS (macOS 10.14+)
- ✅ Linux (Ubuntu 20.04+)

## ドキュメント

### 関連ドキュメント

- [ルーティング設定書](./ルーティング設定書.md)
- [プロジェクト構造](../项目结构.md)
- [README](../README.md)

## 連絡先とサポート

開発に関する質問や問題は、プロジェクトリポジトリの Issue セクションで報告してください。
